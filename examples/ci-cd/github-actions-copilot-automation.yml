# GitHub Actions Workflow: GitHub Copilot Automation
# This example shows how to use GitHub Copilot CLI for automated code generation,
# documentation updates, and test generation in CI/CD pipelines
# Note: Requires GitHub Copilot access and authentication

name: Copilot Automation

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      task:
        description: 'Task to perform'
        required: true
        default: 'generate-tests'
        type: choice
        options:
          - generate-tests
          - update-docs
          - code-review
          - security-audit

jobs:
  automation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Copilot CLI
        run: npm install -g @github/copilot

      - name: Authenticate with GitHub Copilot
        run: |
          echo "GitHub Copilot CLI authentication required"
          echo "Ensure your GitHub account has Copilot access"
          copilot --version || echo "Authentication may be required"

      - name: Generate Tests
        id: generate_tests
        if: github.event.inputs.task == 'generate-tests' || github.event_name == 'push'
        env:
          COPILOT_ALLOW_ALL: 1
        run: |
          copilot -p "Generate unit tests for all Python files in the src/ directory. Create test files in the tests/ directory with the same structure." \
            --model claude-haiku-4.5 \
            --silent \
            --no-color \
            --allow-all-tools \
            > test-generation.log 2>&1 || echo "Test generation completed with warnings"
          
          if [ -f test-generation.log ]; then
            echo "Tests generated. Review test-generation.log for details."
          fi

      - name: Update Documentation
        id: update_docs
        if: github.event.inputs.task == 'update-docs'
        env:
          COPILOT_ALLOW_ALL: 1
        run: |
          copilot -p "Review all markdown files in the docs/ directory and update them to reflect the latest code changes. Ensure all code examples are current and accurate." \
            --model claude-sonnet-4.5 \
            --silent \
            --no-color \
            --allow-all-tools \
            > doc-update.log 2>&1 || echo "Documentation update completed with warnings"

      - name: Code Review
        id: code_review
        if: github.event.inputs.task == 'code-review'
        env:
          COPILOT_ALLOW_ALL: 1
        run: |
          git diff origin/main...HEAD | \
            copilot -p "Review these code changes for bugs, security issues, code quality, and best practices. Provide specific, actionable feedback." \
            --model claude-sonnet-4.5 \
            --silent \
            --no-color \
            --allow-all-tools \
            > code-review.txt 2>&1 || echo "Code review completed with warnings"

      - name: Security Audit
        id: security_audit
        if: github.event.inputs.task == 'security-audit'
        env:
          COPILOT_ALLOW_ALL: 1
        run: |
          copilot -p "Perform a security audit of the codebase. Check for common vulnerabilities, insecure patterns, and compliance issues. Generate a security report." \
            --model claude-sonnet-4.5 \
            --silent \
            --no-color \
            --allow-all-tools \
            > security-audit.txt 2>&1 || echo "Security audit completed with warnings"

      - name: Create Pull Request with Changes
        if: always() && (steps.generate_tests.outcome == 'success' || steps.update_docs.outcome == 'success')
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Automated updates from GitHub Copilot CLI"
          title: "Automated Updates: ${{ github.event.inputs.task || 'generate-tests' }}"
          body: |
            This PR contains automated updates generated by GitHub Copilot CLI.
            
            Task: ${{ github.event.inputs.task || 'generate-tests' }}
            
            Please review the changes before merging.
          branch: copilot-automation/${{ github.run_id }}
          delete-branch: true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: copilot-automation-${{ github.run_id }}
          path: |
            test-generation.log
            doc-update.log
            code-review.txt
            security-audit.txt
          retention-days: 7

      - name: Post Summary Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## ðŸ¤– GitHub Copilot Automation Summary\n\n';
            
            if (fs.existsSync('test-generation.log')) {
              const content = fs.readFileSync('test-generation.log', 'utf8');
              comment += '### Test Generation\n\n' + content.substring(0, 1000) + '\n\n';
            }
            
            if (fs.existsSync('code-review.txt')) {
              const content = fs.readFileSync('code-review.txt', 'utf8');
              comment += '### Code Review\n\n' + content.substring(0, 1000) + '\n\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

